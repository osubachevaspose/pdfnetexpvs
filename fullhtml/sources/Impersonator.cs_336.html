<html>
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=US-ASCII" />
  <title>Impersonator.cs</title>
  <link rel="stylesheet" href="../style.css"/>
  <script src="../jquery-3.5.1.min.js"></script>
</head>
<body>
<pre><code class = "cs">
<a name="ln1">// This is an independent project of an individual developer. Dear PVS-Studio, please check it.</a>
<a name="ln2">// PVS-Studio Static Code Analyzer for C, C++, C#, and Java: https://pvs-studio.com</a>
<a name="ln3">namespace Aspose.Pdf.Examples.CSharp.AsposePDFFacades.Printing</a>
<a name="ln4">{</a>
<a name="ln5">	#region Using directives.</a>
<a name="ln6">	// ----------------------------------------------------------------------</a>
<a name="ln7"> </a>
<a name="ln8">	using System;</a>
<a name="ln9">	using System.Security.Principal;</a>
<a name="ln10">	using System.Runtime.InteropServices;</a>
<a name="ln11">	using System.ComponentModel;</a>
<a name="ln12"> </a>
<a name="ln13">	// ----------------------------------------------------------------------</a>
<a name="ln14">	#endregion</a>
<a name="ln15"> </a>
<a name="ln16">	/////////////////////////////////////////////////////////////////////////</a>
<a name="ln17"> </a>
<a name="ln18">	/// &lt;summary&gt;</a>
<a name="ln19">	/// Impersonation of a user. Allows to execute code under another</a>
<a name="ln20">	/// User context.</a>
<a name="ln21">	/// Please note that the account that instantiates the Impersonator class</a>
<a name="ln22">	/// Needs to have the 'Act as part of operating system' privilege set.</a>
<a name="ln23">	/// &lt;/summary&gt;</a>
<a name="ln24">	/// &lt;remarks&gt;	</a>
<a name="ln25">	/// This class is based on the information in the Microsoft knowledge base</a>
<a name="ln26">	/// Article http:// Support.microsoft.com/default.aspx?scid=kb;en-us;Q306158</a>
<a name="ln27">	/// </a>
<a name="ln28">	/// Encapsulate an instance into a using-directive like e.g.:</a>
<a name="ln29">	/// </a>
<a name="ln30">	///		...</a>
<a name="ln31">	///		using ( new Impersonator( &quot;myUsername&quot;, &quot;myDomainname&quot;, &quot;myPassword&quot; ) )</a>
<a name="ln32">	///		{</a>
<a name="ln33">	///			...</a>
<a name="ln34">	///			[code that executes under the new context]</a>
<a name="ln35">	///			...</a>
<a name="ln36">	///		}</a>
<a name="ln37">	///		...</a>
<a name="ln38">	/// </a>
<a name="ln39">	/// Please contact the author Uwe Keim (mailto:uwe.keim@zeta-software.de)</a>
<a name="ln40">	/// For questions regarding this class.</a>
<a name="ln41">	/// &lt;/remarks&gt;</a>
<a name="ln42">	public class Impersonator :</a>
<a name="ln43">		IDisposable</a>
<a name="ln44">	{</a>
<a name="ln45">		#region Public methods.</a>
<a name="ln46">		// ------------------------------------------------------------------</a>
<a name="ln47"> </a>
<a name="ln48">		/// &lt;summary&gt;</a>
<a name="ln49">		/// Constructor. Starts the impersonation with the given credentials.</a>
<a name="ln50">		/// Please note that the account that instantiates the Impersonator class</a>
<a name="ln51">		/// Needs to have the 'Act as part of operating system' privilege set.</a>
<a name="ln52">		/// &lt;/summary&gt;</a>
<a name="ln53">		/// &lt;param name=&quot;userName&quot;&gt;The name of the user to act as.&lt;/param&gt;</a>
<a name="ln54">		/// &lt;param name=&quot;domainName&quot;&gt;The domain name of the user to act as.&lt;/param&gt;</a>
<a name="ln55">		/// &lt;param name=&quot;password&quot;&gt;The password of the user to act as.&lt;/param&gt;</a>
<a name="ln56">		public Impersonator(</a>
<a name="ln57">			string userName,</a>
<a name="ln58">			string domainName,</a>
<a name="ln59">			string password )</a>
<a name="ln60">		{</a>
<a name="ln61">			ImpersonateValidUser( userName, domainName, password );</a>
<a name="ln62">		}</a>
<a name="ln63"> </a>
<a name="ln64">		// ------------------------------------------------------------------</a>
<a name="ln65">		#endregion</a>
<a name="ln66"> </a>
<a name="ln67">		#region IDisposable member.</a>
<a name="ln68">		// ------------------------------------------------------------------</a>
<a name="ln69"> </a>
<a name="ln70">		public void Dispose()</a>
<a name="ln71">		{</a>
<a name="ln72">			UndoImpersonation();</a>
<a name="ln73">		}</a>
<a name="ln74"> </a>
<a name="ln75">		// ------------------------------------------------------------------</a>
<a name="ln76">		#endregion</a>
<a name="ln77"> </a>
<a name="ln78">		#region P/Invoke.</a>
<a name="ln79">		// ------------------------------------------------------------------</a>
<a name="ln80"> </a>
<a name="ln81">		[DllImport(&quot;advapi32.dll&quot;, SetLastError=true)]</a>
<a name="ln82">		private static extern int LogonUser(</a>
<a name="ln83">			string lpszUserName,</a>
<a name="ln84">			string lpszDomain,</a>
<a name="ln85">			string lpszPassword,</a>
<a name="ln86">			int dwLogonType,</a>
<a name="ln87">			int dwLogonProvider,</a>
<a name="ln88">			ref IntPtr phToken);</a>
<a name="ln89">		</a>
<a name="ln90">		[DllImport(&quot;advapi32.dll&quot;, CharSet=CharSet.Auto, SetLastError=true)]</a>
<a name="ln91">		private static extern int DuplicateToken(</a>
<a name="ln92">			IntPtr hToken,</a>
<a name="ln93">			int impersonationLevel,</a>
<a name="ln94">			ref IntPtr hNewToken);</a>
<a name="ln95"> </a>
<a name="ln96">		[DllImport(&quot;advapi32.dll&quot;, CharSet=CharSet.Auto, SetLastError=true)]</a>
<a name="ln97">		private static extern bool RevertToSelf();</a>
<a name="ln98"> </a>
<a name="ln99">		[DllImport(&quot;kernel32.dll&quot;, CharSet=CharSet.Auto)]</a>
<a name="ln100">		private static extern  bool CloseHandle(</a>
<a name="ln101">			IntPtr handle);</a>
<a name="ln102"> </a>
<a name="ln103">		private const int LOGON32_LOGON_INTERACTIVE = 2;</a>
<a name="ln104">		private const int LOGON32_PROVIDER_DEFAULT = 0;</a>
<a name="ln105"> </a>
<a name="ln106">		// ------------------------------------------------------------------</a>
<a name="ln107">		#endregion</a>
<a name="ln108"> </a>
<a name="ln109">		#region Private member.</a>
<a name="ln110">		// ------------------------------------------------------------------</a>
<a name="ln111"> </a>
<a name="ln112">		/// &lt;summary&gt;</a>
<a name="ln113">		/// Does the actual impersonation.</a>
<a name="ln114">		/// &lt;/summary&gt;</a>
<a name="ln115">		/// &lt;param name=&quot;userName&quot;&gt;The name of the user to act as.&lt;/param&gt;</a>
<a name="ln116">		/// &lt;param name=&quot;domainName&quot;&gt;The domain name of the user to act as.&lt;/param&gt;</a>
<a name="ln117">		/// &lt;param name=&quot;password&quot;&gt;The password of the user to act as.&lt;/param&gt;</a>
<a name="ln118">		private void ImpersonateValidUser(</a>
<a name="ln119">			string userName, </a>
<a name="ln120">			string domain, </a>
<a name="ln121">			string password )</a>
<a name="ln122">		{</a>
<a name="ln123">			WindowsIdentity tempWindowsIdentity = null;</a>
<a name="ln124">			IntPtr token = IntPtr.Zero;</a>
<a name="ln125">			IntPtr tokenDuplicate = IntPtr.Zero;</a>
<a name="ln126"> </a>
<a name="ln127">			try</a>
<a name="ln128">			{</a>
<a name="ln129">				if ( RevertToSelf() )</a>
<a name="ln130">				{</a>
<a name="ln131">					if ( LogonUser(</a>
<a name="ln132">						userName, </a>
<a name="ln133">						domain, </a>
<a name="ln134">						password, </a>
<a name="ln135">						LOGON32_LOGON_INTERACTIVE,</a>
<a name="ln136">						LOGON32_PROVIDER_DEFAULT, </a>
<a name="ln137">						ref token ) != 0 )</a>
<a name="ln138">					{</a>
<a name="ln139">						if ( DuplicateToken( token, 2, ref tokenDuplicate ) != 0 )</a>
<a name="ln140">						{</a>
<a name="ln141">							tempWindowsIdentity = new WindowsIdentity( tokenDuplicate );</a>
<a name="ln142">							impersonationContext = tempWindowsIdentity.Impersonate();</a>
<a name="ln143">						}</a>
<a name="ln144">						else</a>
<a name="ln145">						{</a>
<a name="ln146">							throw new Win32Exception( Marshal.GetLastWin32Error() );</a>
<a name="ln147">						}</a>
<a name="ln148">					}</a>
<a name="ln149">					else</a>
<a name="ln150">					{</a>
<a name="ln151">						throw new Win32Exception( Marshal.GetLastWin32Error() );</a>
<a name="ln152">					}</a>
<a name="ln153">				}</a>
<a name="ln154">				else</a>
<a name="ln155">				{</a>
<a name="ln156">					throw new Win32Exception( Marshal.GetLastWin32Error() );</a>
<a name="ln157">				}</a>
<a name="ln158">			}</a>
<a name="ln159">			finally</a>
<a name="ln160">			{</a>
<a name="ln161">				if ( token!= IntPtr.Zero )</a>
<a name="ln162">				{</a>
<a name="ln163">					CloseHandle( token );</a>
<a name="ln164">				}</a>
<a name="ln165">				if ( tokenDuplicate!=IntPtr.Zero )</a>
<a name="ln166">				{</a>
<a name="ln167">					CloseHandle( tokenDuplicate );</a>
<a name="ln168">				}</a>
<a name="ln169">			}</a>
<a name="ln170">		}</a>
<a name="ln171"> </a>
<a name="ln172">		/// &lt;summary&gt;</a>
<a name="ln173">		/// Reverts the impersonation.</a>
<a name="ln174">		/// &lt;/summary&gt;</a>
<a name="ln175">		private void UndoImpersonation()</a>
<a name="ln176">		{</a>
<a name="ln177">			if ( impersonationContext!=null )</a>
<a name="ln178">			{</a>
<a name="ln179">				impersonationContext.Undo();</a>
<a name="ln180">			}	</a>
<a name="ln181">		}</a>
<a name="ln182"> </a>
<a name="ln183">		private WindowsImpersonationContext impersonationContext = null;</a>
<a name="ln184"> </a>
<a name="ln185">		// ------------------------------------------------------------------</a>
<a name="ln186">		#endregion</a>
<a name="ln187">	}</a>
<a name="ln188"> </a>
<a name="ln189">	/////////////////////////////////////////////////////////////////////////</a>
<a name="ln190">}</a>
</code></pre>
<div class="balloon" rel="42"><p><span style="font-size:18px">&uarr;</span> <a href="https://pvs-studio.com/en/docs/warnings/v3073/" target="_blank">V3073</a> Not all IDisposable members are properly disposed. Call 'Dispose' when disposing 'Impersonator' class. Inspect: impersonationContext.</p></div>
<link rel="stylesheet" href="highlight.css">
<script src="highlight.pack.js"></script>
<script src="highlightjs-line-numbers.js"></script>
<script>hljs.initHighlightingOnLoad();</script>
<script>hljs.initLineNumbersOnLoad();</script>
<script>
  $(document).ready(function() {
      $('.balloon').each(function () {
          var bl = $(this);
          var line = bl.attr('rel');
          var text = $('a[name="ln'+line+'"]').text();

          var space_count = 0;
          for(var i = 0; i<text.length; i++){
              var char = text[i];
              if((char !== ' ')&&(char !== '\t'))break;
              if(char === '\t')space_count++;
              space_count++;
          }

          bl.css('margin-left', space_count*8);
          $('a[name="ln'+line+'"]').after(bl);
      });

      window.location = window.location;
  });
</script>
</body>
</html>